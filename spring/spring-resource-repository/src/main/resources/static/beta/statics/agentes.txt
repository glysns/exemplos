import { QWindow, QInputMask, QInputCedente } from 'components';
import { agenteResource, TipoAgenteEnum, cedenteAgenteResource, plataformaResource } from 'services/formalizacao-model';
import { cpf, notEmpty, required } from 'services/validators';
import LocalizaCedente from './localiza-cedente.vue'

const NOVO_CADASTRO = {
    id: null, 
    nome: '', 
    cpf: '', 
    email: '', 
    tipoAgente: null,
    ativo: true
}
export default {
    name: 'agentes',
    components: { QWindow, QInputMask, QInputCedente, LocalizaCedente },
    data: () => ({
        filtro: { },
        tituloModal: "",
        listaAgentes: [],
        cadastro: NOVO_CADASTRO,
        tipoOperacao:"SEARCH",
        tableModel: {},
        cedentesModel: {},
        searchReq: null,
        filtrandoCedente: false,
        filtroCedentes: {}
    }),
    validations: {
        cadastro: {
            nome: { required, notEmpty },
            cpf: { required, notEmpty, cpf },
            tipoAgente: { required },
            plataforma: { required }
        }
    },
    created() {
        this.$optionsBus
        .register('tipoAgente', TipoAgenteEnum)
        .register('plataforma', () => plataformaResource.list())
        this.tableModel = this.$ui.searchTableModel(agenteResource)
        this.cedentesModel = this.$ui.searchTableModel(cedenteAgenteResource)
            .setRowsPerPage(10)
        this.limpar()
    },
    computed: {
        canShowCedentes() {
            return this.$auth.hasRole('CEDENTES_AGENTES_SEARCH')
        }
    },
    methods: {
        nomeTipo(row) {
            return row.tipoAgente && row.tipoAgente.replace('_', ' ')
        },
        novoCadastro(){
            this.tituloModal="Cadastrar Novo Agente";
            this.tipoOperacao = 'CREATE';
            this.cadastro = Object.copy(NOVO_CADASTRO);
            this.cadastro.tipoAgente = this.filtro.tipoAgente;
            this.cedentesModel.clear()
            this.filtroCedentes = {}
            this.openModal();
            this.$focus('txtNome');
        },  
        editarAgente(row) {
            this.$ui.loading()
            this.cadastro = row;
            this.filtrandoCedente = false
            this.filtroCedentes = {}
            this.openModal()
            agenteResource.getFull(row.id).result(result => {
                this.cadastro = result;
                this.tituloModal = "Atualizar Dados Agente"
                this.tipoOperacao = 'UPDATE'
                this.$focus('txtId')                
            })
            .catch(this.$ui.handlerError('Buscar dados Agente para Atualizar'))
            .finally(this.$ui.unloadOne)
            if (this.canShowCedentes) {
                this.buscarCedentes()
            }
        },
        buscarCedentes() {
            this.cedentesModel.request({ 
                params: { 
                    idAgente: this.cadastro.id,
                    fim: null, 
                    idCedente: this.filtroCedentes.id, 
                    nomeCedente: this.filtroCedentes.razaoSocial 
                }, 
                sort: [ 'cedente.razaoSocial' ] 
            })
        },        
        openModal() {
            this.$ui.clearMessages();
            this.$v.cadastro.$reset();
            this.$refs.cadastroModal.show();
            this.$refs.tabs.selectTab('tab-dados-gerais')
        },
        deletarAgente(row) {
            this.$ui.clearMessages()
            this.$ui.confirm(`Excluir o agente "${row.nome}"?`, () => {
                this.$ui.loading();
                agenteResource.remove(row.id).then(() => {
                    this.$ui.success('Registro removido com sucesso');
                    this.buscar();
                })
                .catch(this.$ui.handlerError('Excluir Agente'))
                .finally(this.$ui.unloadOne)
            })
        },
        addCedente(cedente) {
            if (this.cedentesModel.results.find(it => it.cedente.id == cedente.id)) {
                this.$ui.warn('Cedente já registrado para o agente')
                return
            }
            const message = `Confirma a inclusão do Cedente "${cedente.razaoSocial}" para o agente?`
            this.$ui.confirm(message, () => {
                const cedenteAgente = {
                    cedente: { id: cedente.id },
                    agente: { id: this.cadastro.id }
                }
                this.$ui.loading()
                cedenteAgenteResource.insert(cedenteAgente)
                    .then(() => this.buscarCedentes())
                    .catch(this.$ui.handlerError('Gravar cedente'))
                    .finally(this.$ui.unloadOne)
            })
        },
        removeCedente(cedente) {
            this.$ui.confirm(`Confirma a remoção do cedente "${cedente.razaoSocial}"?`, () => {
                this.$ui.loading()
                const cedenteAgente = {
                    cedente: { id: cedente.id },
                    agente: { id: this.cadastro.id }
                }
                cedenteAgenteResource.desregistrar(cedenteAgente)
                    .then(() => this.buscarCedentes())
                    .catch(this.$ui.handlerError('Remover cedente'))
                    .finally(this.$ui.unloadOne)
            })
        },
        salvarAgente() {
            this.$ui.clearMessages();

            this.$v.cadastro.$touch();
            if(this.$v.cadastro.$error){
                this.$ui.warn('Preencha os campos corretamente.');
                return;
            }
            
            this.$ui.confirm("Confirma a gravação dos dados?", () => {
                this.$ui.loading();
                let insertOrUpdate = agenteResource.insertOrUpdate(this.tipoOperacao, this.cadastro)
                insertOrUpdate.result(id => {
                    this.cadastro.id = id
                    this.tipoOperacao = 'UPDATE'
                    this.$optionsBus.refresh('gerenteConta')
                    this.buscar()
                    this.$ui.success('Dados gravados com sucesso!')
                })
                .catch(this.$ui.handlerError('Cadastrar Documento'))
                .finally(this.$ui.unloadOne())
            })
        },
        buscar() {
            this.$ui.clearMessages();
            this.searchReq = { params: this.filtro, sort: [ 'nome' ] };
            this.tableModel.request(this.searchReq);
        },
        limpar() {
            this.$ui.clearMessages()
            this.filtro = { ativo: true }
            this.searchReq = null
            this.tableModel.clear()
            this.$focus('txtFiltroID')
        },
        iniciarFiltroCedente() {
            this.filtrandoCedente = true
            this.$focus('txtFiltroCedente')
        },
        cancelarFiltroCedente() {
            this.filtrandoCedente = false
            this.filtroCedentes = {}
            this.buscarCedentes()
        }
    }
}

