<template>
    <div class="layout-padding">
        
        <h3>Formalização<q-icon name="keyboard_arrow_right"/>Agente</h3>
        
        <q-card slot="header" class="bg-system">
            <q-card-title class="bg-secondary text-white">
				Consulta
				<q-btn slot="right" icon="add" flat color="white" @click="novoCadastro">
                    Novo Agente
                    <q-tooltip anchor="center left" self="center right">Cadastrar Novo Agente</q-tooltip>
                </q-btn>
			</q-card-title>
            <q-card-separator/>
            <q-card-main class="row gutter-x-xs">
                <div class="col-md-1 ">
                    <q-input stack-label="ID" v-model="filtro.id" ref="txtFiltroID" />
                </div>
                <div class="col-md-3">
                    <q-input stack-label="Nome" v-model="filtro.nome"/>
                </div>
                <div class="col-md-2">
                    <q-input-mask stack-label="CPF" v-model="filtro.cpf" :mask="$masks.cpf" />
                </div>
                <div class="col-md-2">
                    <q-select stack-label="Tipo" v-model="filtro.tipoAgente" clearable :options="$optionsBus.tipoAgente" />
                </div>
                <div class="col-md-3">
                    <q-select stack-label="Plataforma" v-model="filtro.plataforma" clearable :options="$optionsBus.plataforma" />
                </div>
                
                <div class="col-md-1">
                    <q-select stack-label="Ativo" v-model="filtro.ativo" :options="$optionsBus.simNao" />
                </div>
                
                <div class="col-md-4">
                    <q-input-cedente stack-label="Cedente" v-model="filtro.idCedente" fieldValue="id" clearable />
                </div>
                <div class="col-md-2 offset-md-5 row justify-around self-end">
                    <q-btn color="primary" icon="search" flat @click="buscar">Buscar</q-btn>
                    <q-btn color="faded" icon="cancel" flat @click="limpar">Limpar</q-btn>
                </div>
            </q-card-main>
            <q-card-actions/>
        </q-card>
        
        <q-data-table title="Agentes" v-if="tableModel.requested" row-key="id"
			:tableModel="tableModel" :columns="[
                {name:'actions', width: '70px', class: 'no-padding'},
                {name: 'id', label:'ID', field:'id', sortable: true, type: 'number', width: '50px'},
                {name: 'nome', label:'Nome', field:'nome', align: 'left', sortable: true, width: '300px'},
                {name: 'cpf', label:'CPF', field: 'cpf', align: 'center', sortable: true, format: $format.cpf },
                {name: 'dataAdmissao', label:'Admissão', field: 'dataAdmissao',format: $format.data, align: 'left', sortable: true, width: '300px' },
                {name: 'email', label:'E-Mail', field: 'email', align: 'left', sortable: true, width: '300px' },
                {name: 'tipoAgente', label:'Tipo Agente', field: nomeTipo, align: 'left', sortable: true, width: '150px' },
                {name: 'plataforma', label:'Plataforma', field: $ui.field('plataforma.nome'), align: 'left', sortable: true, width: '170px' },
                {name: 'ativo', label:'Ativo', field:'ativo', align: 'left', sortable: true, format: $format.simNao},
			]">
			<template slot="cell-actions" slot-scope="props" :props="props">
				<q-btn small flat icon="edit" @click="editarAgente(props.row)"  title="Alterar" />
				<q-btn small flat icon="delete" @click="deletarAgente(props.row)" title="Remover" />
			</template>
		</q-data-table>
        <q-window ref="cadastroModal" :title="tituloModal" :size="[650, 490]">
            <q-tabs ref="tabs" color="secondary">
                <q-tab slot="title" name="tab-dados-gerais" label="Dados Gerais" default />
                <q-tab slot="title" name="tab-cedentes" label="Cedentes" v-show="cadastro.id != null && canShowCedentes" />

                <q-tab-pane keep-alive name="tab-dados-gerais" class="row gutter-x-xs">
                    <q-field class="col-md-2 readonly">
                        <q-input stack-label="ID" ref="txtId" v-model="cadastro.id" readonly/>
                    </q-field>
                    <q-field class="col-md-10" v-validate>
                        <q-input stack-label="Nome" ref="txtNome" v-model="cadastro.nome"/>
                    </q-field>
                    <q-field class="col-md-3" v-validate>
                        <q-input-mask stack-label="CPF" v-model="cadastro.cpf" :mask="$masks.cpf" />
                    </q-field>
                    <q-field class="col-md-9">
                        <q-input stack-label="E-Mail" v-model="cadastro.email"/>
                    </q-field>
                    <q-field class="col-md-3" v-validate>
                        <q-select stack-label="Tipo" v-model="cadastro.tipoAgente" :options="$optionsBus.tipoAgente" />
                    </q-field>
                    <q-field class="col-md-4" v-validate>
                        <q-combo stack-label="Plataforma" v-model="cadastro.plataforma" :options="$optionsBus.plataforma" />
                    </q-field>
                    <q-field class="col-md-3" v-validate>
                        <q-input-date stack-label="Data Admissão" v-model="cadastro.dataAdmissao"/>
                    </q-field>
                    <q-field class="col-md-2 q-pt-md">
                        <q-checkbox v-model="cadastro.ativo" label="Ativo" />
                    </q-field>
                </q-tab-pane>
                <q-tab-pane keep-alive name="tab-cedentes" class="no-padding" v-if="cadastro.id != null && canShowCedentes">
                    <q-table dense row-key="id" class="flat compact" v-table-ext :hide-header="false"
                        :data="cedentesModel.results" :selected.sync="cedentesModel.selected" :pagination.sync="cedentesModel.pagination"
                        @request="cedentesModel.request" :rows-per-page-options="cedentesModel.pageOptions"
                        :loading="cedentesModel.loading" :columns="$ui.columnsBuilder()
                            .name('actions').center().width('30px')
                            .name('cedente.id').label('ID').right().sortable().width('50px')
                            .name('cedente.razaoSocial').label('Nome').left().sortable().width('350px')                           
                        .build()">

                        <q-tr slot="header" slot-scope="props" :props="props">
                            <q-th>
                                <q-btn small flat color="primary" icon="person_add" @click="$refs.localizaCedente.cleanAndShow()" title="Adicionar Cedente" />
                            </q-th>
                            <q-th class="text-right" >ID</q-th>
                            <q-th>
                                <div class="row items-center" v-if="!filtrandoCedente">
                                    <span class="col-11">Razão Social</span>
                                    <q-btn class="col-1" small flat icon="search" @click="iniciarFiltroCedente" title="Pesquisar Cedente" />
                                </div>
                                <div class="row" v-else>
                                    <q-input class="col-11" placeholder="Pesquisar" v-model="filtroCedentes.razaoSocial" @keyup.enter="buscarCedentes" ref="txtFiltroCedente" />
                                    <q-btn class="col-1" small flat icon="cancel" @click="cancelarFiltroCedente" title="Cancelar Pesquisa" />
                                </div>
                            </q-th>
                        </q-tr>
                        <q-td slot="body-cell-actions" class="no-padding" slot-scope="props" :props="props">
                            <q-btn small flat icon="delete" @click="removeCedente(props.row.cedente)" title="Remover" />
                        </q-td>
                    </q-table>
                </q-tab-pane>
            </q-tabs>
            <q-toolbar slot="footer" inverted >
                <q-toolbar-title />
                <q-btn icon="save" color="primary" @click="salvarAgente">Salvar</q-btn>
                <q-btn flat icon="close" @click="$refs.cadastroModal.hide()">Fechar</q-btn>
            </q-toolbar>
        </q-window>
        <localiza-cedente ref="localizaCedente" @select="addCedente" />
    </div>
</template>
<script src="./agentes.js"></script>
